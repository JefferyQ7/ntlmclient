#include "ntlm_tests.h"

/*
 * Most of this test data comes from Eric Glass'
 * "The NTLM Authentication Protocol and Security Support Provider".
 * http://davenport.sourceforge.net/ntlm.html
 */

void test_challenge__initialize(void)
{
}

void test_challenge__cleanup(void)
{
}

void test_challenge__can_proceed_without_negotiate(void)
{
	ntlm_client *ntlm;

	const unsigned char challenge_msg[] = {
		0x4e, 0x54, 0x4c, 0x4d, 0x53, 0x53, 0x50, 0x00, 0x02,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x02, 0x02, 0x00, 0x00, 0x01, 0x23, 0x45,
		0x67, 0x89, 0xab, 0xcd, 0xef,
	};

	cl_assert((ntlm = ntlm_client_init(NTLM_CLIENT_DEFAULTS)) != NULL);
	cl_ntlm_pass(ntlm, ntlm_client_set_challenge(ntlm,
		challenge_msg, sizeof(challenge_msg)));
	ntlm_client_free(ntlm);
}

void test_challenge__minimal(void)
{
	ntlm_client *ntlm;
	const unsigned char *negotiate_msg;
	size_t negotiate_msg_len;

	const unsigned char challenge_msg[] = {
		0x4e, 0x54, 0x4c, 0x4d, 0x53, 0x53, 0x50, 0x00, 0x02,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x02, 0x02, 0x00, 0x00, 0x01, 0x23, 0x45,
		0x67, 0x89, 0xab, 0xcd, 0xef,
	};

	cl_assert((ntlm = ntlm_client_init(NTLM_CLIENT_DEFAULTS)) != NULL);
	cl_ntlm_pass(ntlm, ntlm_client_negotiate(&negotiate_msg,
		&negotiate_msg_len, ntlm));
	cl_ntlm_pass(ntlm, ntlm_client_set_challenge(ntlm,
		challenge_msg, sizeof(challenge_msg)));
	cl_assert_equal_p(NULL, ntlm_client_target(ntlm));
	ntlm_client_free(ntlm);
}

void test_challenge__sample(void)
{
	ntlm_client *ntlm;
	const unsigned char *negotiate_msg;
	size_t negotiate_msg_len;

	const unsigned char challenge_msg[] = {
		0x4e, 0x54, 0x4c, 0x4d, 0x53, 0x53, 0x50, 0x00,
		0x02, 0x00, 0x00, 0x00, 0x0c, 0x00, 0x0c, 0x00,
		0x30, 0x00, 0x00, 0x00, 0x01, 0x02, 0x81, 0x00,
		0x01, 0x23, 0x45, 0x67, 0x89, 0xab, 0xcd, 0xef,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x62, 0x00, 0x62, 0x00, 0x3c, 0x00, 0x00, 0x00,
		0x44, 0x00, 0x4f, 0x00, 0x4d, 0x00, 0x41, 0x00,
		0x49, 0x00, 0x4e, 0x00, 0x02, 0x00, 0x0c, 0x00,
		0x44, 0x00, 0x4f, 0x00, 0x4d, 0x00, 0x41, 0x00,
		0x49, 0x00, 0x4e, 0x00, 0x01, 0x00, 0x0c, 0x00,
		0x53, 0x00, 0x45, 0x00, 0x52, 0x00, 0x56, 0x00,
		0x45, 0x00, 0x52, 0x00, 0x04, 0x00, 0x14, 0x00,
		0x64, 0x00, 0x6f, 0x00, 0x6d, 0x00, 0x61, 0x00,
		0x69, 0x00, 0x6e, 0x00, 0x2e, 0x00, 0x63, 0x00,
		0x6f, 0x00, 0x6d, 0x00, 0x03, 0x00, 0x22, 0x00,
		0x73, 0x00, 0x65, 0x00, 0x72, 0x00, 0x76, 0x00,
		0x65, 0x00, 0x72, 0x00, 0x2e, 0x00, 0x64, 0x00,
		0x6f, 0x00, 0x6d, 0x00, 0x61, 0x00, 0x69, 0x00,
		0x6e, 0x00, 0x2e, 0x00, 0x63, 0x00, 0x6f, 0x00,
		0x6d, 0x00, 0x00, 0x00, 0x00, 0x00,
	};

	cl_assert((ntlm = ntlm_client_init(NTLM_CLIENT_DEFAULTS)) != NULL);
	cl_ntlm_pass(ntlm, ntlm_client_negotiate(&negotiate_msg,
		&negotiate_msg_len, ntlm));
	cl_ntlm_pass(ntlm, ntlm_client_set_challenge(ntlm,
			challenge_msg, sizeof(challenge_msg)));

	cl_assert_equal_i(htonll(0x0123456789abcdef),
		ntlm_client_challenge_nonce(ntlm));

	cl_assert_equal_s("DOMAIN", ntlm_client_target(ntlm));
	cl_assert_equal_s("DOMAIN", ntlm_client_target_domain(ntlm));
	cl_assert_equal_s("SERVER", ntlm_client_target_server(ntlm));
	cl_assert_equal_s("domain.com", ntlm_client_target_domain_dns(ntlm));
	cl_assert_equal_s("server.domain.com", ntlm_client_target_server_dns(ntlm));

	ntlm_client_free(ntlm);
}
